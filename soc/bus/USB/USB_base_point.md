# USB基础概念


## 关键字

### 端点

位于USB设备或主机上的一个数据缓冲区，用来存放和发送USB的各种数据，每一个端点都有惟一的确定地址，有不同的传输特性（如输入端点、输出端点、配置端点、批量传输端点）

### 帧

时间概念，在USB中，一帧就是1MS，它是一个独立的单元，包含了一系列总线动作，USB将1帧分为好几份，每一份中是一个USB的传输动作。

### 上行、下行

设备到主机为上行，主机到设备为下行



## 数据格式

>域 --> 包 --> 事务 --> 传输

### 域

USB数据最小的单位，由若干位组成（至于是多少位由具体的域决定），域可分为七个类型

#### 同步域(SYNC)

`八位`，值固定为`0000 0001`，用于本地时钟与输入同步

#### 标识域(PID)

由`四位`标识符+四位标识符反码构成，表明包的类型和格式，这是一个很重要的部分，这里可以计算出，USB的标识码有16种

>标识符:标识码由四位数据组成，因此可以表示十六种标识码，在USB1.1规范里面，只用了十种标识码，USB2.0使用了十六种标识码，标识码的作用是用来说明包的属性的，标识码是和包联系在一起的，首先简单介绍一下数据包的类型，数据包分为令牌包、数据、握手包和特殊包四种, 标识码分别有以下十六种：

```
令牌包:
	0x01 输出(OUT）启动一个方向为主机到设备的传输，并包含了设备地址和标号
	0x09 输入 (IN) 启动一个方向为设备到主机的传输，并包含了设备地址和标号
	0x05 帧起始（SOF）表示一个帧的开始，并且包含了相应的帧号
	0x0d 设置（SETUP）启动一个控制传输，用于主机对设备的初始化
数据包:
	0x03 偶数据包（DATA0），
	0x0b 奇数据包（DATA1）
握手包:
	0x02 确认接收到无误的数据包（ACK）
	0x0a 无效，接收（发送）端正在忙而无法接收（发送）信息
	0x0e 错误，端点被禁止或不支持控制管道请求
特殊包:
	0x0C 前导，用于启动下行端口的低速设备的数据传输
```

#### 地址域(ADDR)

`七位`地址，代表了设备在主机上的地址，地址`000 0000`被命名为零地址，是任何一个设备第一次连接到主机时，在被主机配置、枚举前的默认地址，由此可以知道为什么一个USB主机只能接127个设备的原因。

#### 端点域(ENDP)

`四位`，由此可知一个USB设备有的端点数量最大为16个

#### 帧号域(FRAM)

`11位`，每一个帧都有一个特定的帧号，帧号域最大容量0x800，对于同步传输有重要意义

#### 数据域(DATA)

长度为`0~1023`字节，在不同的传输类型中，数据域的长度各不相同，但必须为整数个字节的长度

#### 校验域

对令牌包和数据包（对于包的分类请看下面）中非PID域进行校验的一种方法，CRC校验在通讯中应用很泛，是一种很好的校验方法，至于具体的校验方法这里就不多说，请查阅相关资料，只须注意CRC码的除法是模2运算，不同于10进制中的除法。

### 包

由域构成的包有四种类型，分别是令牌包、数据包、握手包和特殊包，前面三种是重要的包，不同的包的域结构不同

#### 令牌包

可分为`输入包`、`输出包`、`设置包`和`帧起始包`（注意这里的输入包是用于设置输入命令的，输出包是用来设置输出命令的，而不是放据数的）

* 其中输入包、输出包和设置包的格式都是一样的： `SYNC+PID+ADDR+ENDP+CRC5`（五位的校验码）
* 帧起始包的格式： `SYNC+PID+11位FRAM+CRC5`（五位的校验码）

#### 数据包

分为`DATA0包`和`DATA1包`.
当USB发送数据的时候，当一次发送的数据长度大于相应端点的容量时，就需要把数据包分为好几个包，分批发送，DATA0包和DATA1包交替发送，即如果第一个数据包是 DATA0，那第二个数据包就是DATA1。但也有例外情况，在同步传输中（四类传输类型中之一），所有的数据包都是为DATA0
格式如下： `SYNC+PID+0~1023字节+CRC16`

#### 握手包

结构最为简单的包，格式如下: `SYNC+PID`

### 事务

分别有`IN事务`、`OUT事务`和`SETUP事务`三大事务，每一种事务都由令牌包、数据包、握手包三个阶段构成，这里用阶段的意思是因为这些包的发送是有一定的时间先后顺序的，事务的三个阶段如下：

1. 令牌包阶段：启动一个输入、输出或设置的事务
2. 数据包阶段：按输入、输出发送相应的数据
3. 握手包阶段：返回数据接收情况，在同步传输的IN和OUT事务中没有这个阶段，这是比较特殊的。

#### IN事务

令牌包阶段 —— 主机发送一个PID为IN的输入包给设备，通知设备要往主机发送数据；
数据包阶段 —— 设备根据情况会作出三种反应（要注意：**数据包阶段也不总是传送数据的，根据传输情况还会提前进入握手包阶段**）

1. 设备端点正常，设备往入主机里面发出数据包（DATA0与DATA1交替）；
2. 设备正在忙，无法往主机发出数据包就发送NAK无效包，IN事务提前结束，到了下一个IN事务才继续；
3. 相应设备端点被禁止，发送错误包STALL包，事务也就提前结束了，总线进入空闲状态。

握手包阶段 —— 主机正确接收到数据之后就会向设备发送ACK包。

#### OUT事务

令牌包阶段 —— 主机发送一个PID为OUT的输出包给设备，通知设备要接收数据；
数据包阶段 —— 比较简单，就是主机会设备送数据，DATA0与DATA1交替
握手包阶段 —— 设备根据情况会作出三种反应

1. 设备端点接收正确，设备往入主机返回ACK，通知主机可以发送新的数据，如果数据包发生了CRC校验错误，将不返回任何握手信息；
2. 设备正在忙，无法往主机发出数据包就发送NAK无效包，通知主机再次发送数据；
3. 相应设备端点被禁止，发送错误包STALL包，事务提前结束，总线直接进入空闲状态。

#### SETUP事务

令牌包阶段 —— 主机发送一个PID为SETUP的输出包给设备，通知设备要接收数据；
数据包阶段 —— 比较简单，就是主机会设备送数据，注意，这里只有一个固定为8个字节的DATA0包，这8个字节的内容就是标准的USB设备请求命令（共有11条，具体请看问题七）
握手包阶段 —— 设备接收到主机的命令信息后，返回ACK，此后总线进入空闲状态，并准备下一个传输（在SETUP事务后通常是一个IN或OUT事务构成的传输）

### 传输

传输由OUT、IN、SETUP事务其中的事务构成，传输有四种类型，中断传输、批量传输、同步传输、控制传输，其中中断传输和批量转输的结构一样，同步传输有最简单的结构，而控制传输是最重要的也是最复杂的传输。

#### 中断传输

由OUT事务和IN事务构成，用于键盘、鼠标等HID设备的数据传输中

#### 批量传输

由OUT事务和IN事务构成，用于大容量数据传输，没有固定的传输速率，也不占用带宽，当总线忙时，USB会优先进行其他类型的数据传输，而暂时停止批量转输。

#### 同步传输

由OUT事务和IN事务构成，有两个特殊地方
第一，在同步传输的IN和OUT事务中是没有返回包阶段的；
第二，在数据包阶段所有的数据包都为DATA0

#### 控制传输

最重要的也是最复杂的传输，控制传输由三个阶段构成（初始设置阶段、可选数据阶段、状态信息步骤），每一个阶段可以看成一个的传输，也就是说控制传输其实是由三个传输构成的，用来于USB设备初次加接到主机之后，主机通过控制传输来交换信息，设备地址和读取设备的描述符，使得主机识别设备，并安装相应的驱动程序，这是每一个USB开发者都要关心的问题。

1. 初始设置步骤：就是一个由SET事务构成的传输
2. 可选数据步骤：就是一个由IN或OUT事务构成的传输，这个步骤是可选的，要看初始设置步骤有没有要求读/写数据（由SET事务的数据包阶段发送的标准请求命令决定）
3. 状态信息步骤：顾名思义，这个步骤就是要获取状态信息，由IN或OUT事务构成构成的传输

>但是要注意这里的IN和OUT事务和之前的INT和OUT事务有两点不同：
>1） 传输方向相反，通常IN表示设备往主机送数据，OUT表示主机往设备送数据；在这里，IN表示主机往设备送数据，而OUT表示设备往主机送数据，这是为了和可选数据步骤相结合；
>2） 在这个步骤里，数据包阶段的数据包都是0长度的，即`SYNC+PID+CRC16`

## 附

### HID设备

HID（Human Interface Device）人机接口设备类别是Windows最早支持的USB类别。由其名称可以了解HID设备是计算机直接与人交互的设备，例如键盘、鼠标和游戏杆等。不过HID设备不一定要有人机接口，只要符合HID类别规范，就都是HID设备。


## 参考

1. [http://blog.sina.com.cn/s/blog_4b4b54da010158va.html](http://blog.sina.com.cn/s/blog_4b4b54da010158va.html)
